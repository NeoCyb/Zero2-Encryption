<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Zero2 Encryption - RAM-only Secure</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#0f0f1a;color:#e0e0e0;margin:0;padding:0}
header{display:flex;justify-content:center;background:#14142b;padding:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.5)}
header button{background:#1f1e3d;border:none;padding:.7rem 1.2rem;color:#e0e0e0;margin:0 .5rem;cursor:pointer;border-radius:6px;font-weight:700;transition:.2s}
header button:hover{background:#3a3870}
.section{display:none;padding:1rem 2rem;max-width:900px;margin:2rem auto;background:#1b1a33;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.6)}
.section.active{display:block}
h1{text-align:center;margin-top:1rem;color:#7f5af0}
textarea{width:100%;height:160px;margin-top:.5rem;padding:.5rem;border-radius:5px;border:none;background:#2b2a50;color:#fff;resize:vertical}
.controls{display:flex;justify-content:space-between;align-items:center;margin-top:.5rem}
button.copy,button.paste{background:#3b3a6a;border:none;padding:.35rem .7rem;cursor:pointer;border-radius:5px;color:#fff;font-size:.9rem;display:flex;align-items:center;margin-left:.4rem}
.row{display:flex;gap:.6rem;align-items:center}
input[type=file],input[type=password]{width:100%;padding:.5rem;border-radius:5px;border:none;background:#2b2a50;color:#fff;margin-bottom:.5rem}
button.action{background:#7f5af0;color:white;padding:.6rem 1.2rem;border:none;border-radius:6px;cursor:pointer;font-weight:700;margin-top:.5rem;transition:.2s}
button.action:hover{background:#9966ff}
.small{font-size:.85rem;color:#bdbddb;margin-top:.5rem}
.preview img,.preview video{max-width:100%;margin-top:1rem;border-radius:6px;display:block}
a.download-link{display:inline-block;margin-top:.6rem;color:#cfc9ff;text-decoration:underline}
#overlay{position:fixed;inset:0;background:#000000cc;display:none;align-items:center;justify-content:center;z-index:9999;color:#fff;font-size:1.2rem}
.muted{color:#aaa;font-size:.9rem}
</style>
</head>
<body>
<h1>Zero2 Encryption — RAM-only </h1>
<header>
  <button onclick="showSection('encrypt')">Encrypt</button>
  <button onclick="showSection('decrypt')">Decrypt</button>
</header>

<div id="overlay">Devtools detected — UI locked for security</div>

<section id="encrypt" class="section active">
  <h2>Encrypt</h2>
  <input id="encFile" type="file" accept="*/*">
  <input id="encPass" type="password" placeholder="Enter password (required)" oninput="checkPassword()">
  <div id="passwordStrength" class="small"></div>
  <div class="row" style="margin-top:.4rem">
    <button class="action" onclick="encryptFile()">Encrypt (RAM-only)</button>
    <div class="muted" style="margin-left:1rem">Files kept only in memory unless you click download</div>
  </div>

  <div class="controls" style="margin-top:1rem">
    <label>Encrypted Output (Base64)</label>
    <div class="row">
      <button class="copy" onclick="copyEncrypted()">Copy</button>
      <button class="paste" onclick="pasteIntoEncOutput()">Paste</button>
    </div>
  </div>
  <textarea id="encOutput" readonly placeholder="Encrypted base64 will appear here (only in memory)"></textarea>
  <div id="encDownloadArea"></div>
</section>

<section id="decrypt" class="section">
  <h2>Decrypt</h2>
  <input id="decFile" type="file" accept="*/*">
  <input id="decPass" type="password" placeholder="Enter password (required)">
  <div class="row" style="margin-top:.4rem">
    <button class="action" onclick="decryptFile()">Decrypt (RAM-only)</button>
    <div class="muted" style="margin-left:1rem">No persistent storage — download only when you click the link</div>
  </div>

  <div class="controls" style="margin-top:1rem">
    <label>Encrypted Input (Base64)</label>
    <div class="row">
      <button class="paste" onclick="pasteEncrypted()">Paste</button>
      <button class="copy" onclick="copyDecInput()">Copy</button>
    </div>
  </div>
  <textarea id="decInput" placeholder="Paste encrypted base64 here (or choose file)"></textarea>

  <div id="preview" class="preview"></div>
  <div id="decDownloadArea"></div>
</section>

<script>
// CONFIG
const CHUNK_SIZE = 4 * 1024 * 1024; 
const PBKDF2_ITERS = 300000;
const SALT_BYTES = 16;
const IV_BYTES = 12;
const FK_BYTES = 32;
const HEADER_MAGIC = '02EN';
const VERSION = 1;

// UI helpers
function showSection(id) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  clearPreview();
}
function clearPreview() {
  const p = document.getElementById('preview');
  if(!p) return;
  const objs = p.querySelectorAll('img,video,textarea');
  objs.forEach(o=>{
    if(o.src?.startsWith('blob:')) try{URL.revokeObjectURL(o.src);}catch(e){}
    o.remove();
  });
  p.innerHTML='';
  document.getElementById('decDownloadArea').innerHTML='';
}

// UTIL
function randBytes(len){const a=new Uint8Array(len);crypto.getRandomValues(a);return a;}
function uint16BE(n){return new Uint8Array([(n>>8)&0xff,n&0xff]);}
function uint32BE(n){return new Uint8Array([(n>>>24)&0xff,(n>>>16)&0xff,(n>>>8)&0xff,n&0xff]);}
function readUint32BE(buf,offset=0){const u=new Uint8Array(buf,offset,4);return(u[0]<<24)|(u[1]<<16)|(u[2]<<8)|u[3];}
function bufToBase64(buf){const bytes=new Uint8Array(buf);let binary='';const chunk=0x8000;for(let i=0;i<bytes.length;i+=chunk){binary+=String.fromCharCode.apply(null,Array.from(bytes.subarray(i,i+chunk)));}return btoa(binary);}
function base64ToBuf(b64){const binary=atob(b64);const len=binary.length;const bytes=new Uint8Array(len);for(let i=0;i<len;i++)bytes[i]=binary.charCodeAt(i);return bytes.buffer;}
function zeroBuffer(typed){if(!typed) return;for(let i=0;i<typed.length;i++)typed[i]=0;}

// KDF
async function deriveKeyPBKDF2(password,salt,iterations=PBKDF2_ITERS){
  const enc=new TextEncoder();
  const passKey=await crypto.subtle.importKey('raw',enc.encode(password),'PBKDF2',false,['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations,hash:'SHA-256'},passKey,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);
}

// ENCRYPT
async function encryptFile(){
  document.getElementById('encOutput').value='';
  document.getElementById('encDownloadArea').innerHTML='';
  clearPreview();
  const fileIn=document.getElementById('encFile');
  const pass=document.getElementById('encPass').value||'';
  if(!fileIn.files.length){alert('Select a file to encrypt.');return;}
  if(!pass){alert('Enter a password.');return;}
  const file=fileIn.files[0];
  const salt=randBytes(SALT_BYTES);
  const ivPrefix=randBytes(4);
  const fk=randBytes(FK_BYTES);
  const kek=await deriveKeyPBKDF2(pass,salt);
  const headerForWrap=new TextEncoder().encode(JSON.stringify({magic:HEADER_MAGIC,version:VERSION,name:file.name,type:file.type||'application/octet-stream',chunkSize:CHUNK_SIZE,kdf:'PBKDF2',kdfIters:PBKDF2_ITERS}));
  const wrapIv=randBytes(12);
  const wrappedFkBuf=await crypto.subtle.encrypt({name:'AES-GCM',iv:wrapIv,additionalData:headerForWrap},kek,fk.buffer);
  const headerJSON=JSON.stringify({magic:HEADER_MAGIC,version:VERSION,name:file.name,type:file.type||'application/octet-stream',chunkSize:CHUNK_SIZE,kdf:'PBKDF2',kdfIters:PBKDF2_ITERS,wrapIv:bufToBase64(wrapIv),wrappedFkLen:wrappedFkBuf.byteLength});
  const headerBytes=new TextEncoder().encode(headerJSON);
  const headerLen=headerBytes.length;
  if(headerLen>65535){alert('Header too large');return;}
  const parts=[];
  parts.push(new TextEncoder().encode(HEADER_MAGIC));
  parts.push(new Uint8Array([VERSION]));
  parts.push(uint16BE(headerLen));
  parts.push(headerBytes);
  parts.push(salt);
  parts.push(wrapIv);
  parts.push(uint32BE(wrappedFkBuf.byteLength));
  parts.push(new Uint8Array(wrappedFkBuf));
  const fkCryptoKey=await crypto.subtle.importKey('raw',fk.buffer,{name:'AES-GCM'},false,['encrypt','decrypt']);
  const totalSize=file.size;
  let offset=0,chunkIndex=0;
  while(offset<totalSize){
    const sliceEnd=Math.min(offset+CHUNK_SIZE,totalSize);
    const slice=file.slice(offset,sliceEnd);
    const arrayBuffer=await slice.arrayBuffer();
    const counter=BigInt(chunkIndex);
    const iv=new Uint8Array(12); iv.set(ivPrefix,0);
    for(let i=0;i<8;i++){iv[11-i]=Number((counter>>BigInt(i*8))&0xffn);}
    const aad=uint32BE(chunkIndex);
    const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv,additionalData:aad},fkCryptoKey,arrayBuffer);
    const ctU8=new Uint8Array(ct);
    parts.push(uint32BE(chunkIndex)); parts.push(iv); parts.push(uint32BE(ctU8.length)); parts.push(ctU8);
    zeroBuffer(new Uint8Array(arrayBuffer));
    chunkIndex++; offset=sliceEnd;
  }
  let total=0; for(const p of parts) total+=p.length;
  const outArr=new Uint8Array(total); let pos=0; for(const p of parts){outArr.set(p,pos); pos+=p.length;}
  const b64=bufToBase64(outArr.buffer);
  zeroBuffer(fk); zeroBuffer(outArr); parts.length=0;
  document.getElementById('encOutput').value=b64;
  const dlArea=document.getElementById('encDownloadArea'); dlArea.innerHTML='';
  const dlBtn=document.createElement('button'); dlBtn.className='action'; dlBtn.textContent='Create & Download Encrypted File';
  dlBtn.onclick=()=>{
    const bin=base64ToBuf(b64);
    const blob=new Blob([bin],{type:'application/octet-stream'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=file.name+'.02enc'; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>{try{URL.revokeObjectURL(url);}catch(e){}},2000); zeroBuffer(new Uint8Array(bin));
  }; dlArea.appendChild(dlBtn);
  alert('Encryption completed. Encrypted base64 is in the output textarea (RAM only).');
}

// DECRYPT
async function decryptFile(){
  clearPreview();
  document.getElementById('decDownloadArea').innerHTML='';
  const fileIn=document.getElementById('decFile'); const pass=document.getElementById('decPass').value||''; const textArea=document.getElementById('decInput');
  let dataBuf;
  try{
    if(fileIn.files.length)dataBuf=await fileIn.files[0].arrayBuffer();
    else{const b64=textArea.value.trim(); if(!b64){alert('Provide encrypted base64 or file.');return;} dataBuf=base64ToBuf(b64);}
    const dataU8=new Uint8Array(dataBuf); let pos=0;
    const magic=new TextDecoder().decode(dataU8.slice(pos,pos+4)); pos+=4; if(magic!==HEADER_MAGIC) throw new Error('Invalid file format'); 
    const ver=dataU8[pos]; pos+=1;
    const hdrLen=(dataU8[pos]<<8)|dataU8[pos+1]; pos+=2;
    const headerBytes=dataU8.slice(pos,pos+hdrLen); pos+=hdrLen; const header=JSON.parse(new TextDecoder().decode(headerBytes));
    const salt=dataU8.slice(pos,pos+SALT_BYTES); pos+=SALT_BYTES;
    const wrapIv=dataU8.slice(pos,pos+12); pos+=12;
    const wrappedLen=readUint32BE(dataBuf,pos); pos+=4;
    const wrappedFk=dataU8.slice(pos,pos+wrappedLen); pos+=wrappedLen;
    if(!pass){alert('Enter password.'); return;}
    const kek=await deriveKeyPBKDF2(pass,salt);
    const headerForWrap=new TextEncoder().encode(JSON.stringify({magic:HEADER_MAGIC,version:ver,name:header.name,type:header.type,chunkSize:header.chunkSize,kdf:'PBKDF2',kdfIters:header.kdfIters}));
    const fkBuf=await crypto.subtle.decrypt({name:'AES-GCM',iv:wrapIv,additionalData:headerForWrap},kek,wrappedFk.buffer);
    const fkU8=new Uint8Array(fkBuf);
    const fkCryptoKey=await crypto.subtle.importKey('raw',fkU8.buffer,{name:'AES-GCM'},false,['encrypt','decrypt']);
    const chunks=[];
    while(pos<dataU8.length){
      const chunkIndex=readUint32BE(dataBuf,pos); pos+=4;
      const iv=dataU8.slice(pos,pos+12); pos+=12;
      const ctLen=readUint32BE(dataBuf,pos); pos+=4;
      const ct=dataU8.slice(pos,pos+ctLen); pos+=ctLen;
      const aad=uint32BE(chunkIndex);
      const plain=await crypto.subtle.decrypt({name:'AES-GCM',iv,additionalData:aad},fkCryptoKey,ct.buffer);
      chunks.push(new Uint8Array(plain));
    }
    let total=0; for(const c of chunks) total+=c.length;
    const out=new Uint8Array(total); let p=0; for(const c of chunks){out.set(c,p); p+=c.length;}
    for(let i=0;i<chunks.length;i++){zeroBuffer(chunks[i]); chunks[i]=null;}
    const blob=new Blob([out.buffer],{type:header.type||'application/octet-stream'});
    const preview=document.getElementById('preview');
    const url=URL.createObjectURL(blob);
    if(header.type?.startsWith('image/')){const img=document.createElement('img'); img.onload=()=>{try{URL.revokeObjectURL(url);}catch(e){} img.onload=null;}; img.src=url; img.alt=header.name; preview.appendChild(img);}
    else if(header.type?.startsWith('video/')){const v=document.createElement('video'); v.controls=true; v.onloadeddata=()=>{try{URL.revokeObjectURL(url);}catch(e){} v.onloadeddata=null;}; v.src=url; preview.appendChild(v);}
    else if(header.type?.startsWith('text/')){const txt=await blob.text(); const ta=document.createElement('textarea'); ta.style.width='100%'; ta.style.height='200px'; ta.value=txt; preview.appendChild(ta);}
    else{const div=document.createElement('div'); div.textContent=`Decrypted: ${header.name} (${header.type})`; preview.appendChild(div);}
    const dlArea=document.getElementById('decDownloadArea'); dlArea.innerHTML='';
    const dlBtn=document.createElement('button'); dlBtn.className='action'; dlBtn.textContent='Download Decrypted File';
    dlBtn.onclick=()=>{const dlUrl=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=dlUrl; a.download=header.name||'decrypted.bin'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>{try{URL.revokeObjectURL(dlUrl);}catch(e){}},2000);}
    dlArea.appendChild(dlBtn);
    zeroBuffer(fkU8); zeroBuffer(out);
    alert('Decryption successful. File held only in RAM; download when ready.');
  }catch(e){console.error(e); alert('Decryption failed: '+(e.message||e));}
}

// COPY/PASTE
async function copyEncrypted(){const v=document.getElementById('encOutput').value; if(!v){alert('No encrypted output to copy'); return;} try{await navigator.clipboard.writeText(v); alert('Encrypted copied');}catch(e){alert('Copy failed: '+e.message);}}
async function pasteIntoEncOutput(){try{const t=await navigator.clipboard.readText(); document.getElementById('encOutput').value=t; alert('Pasted into encrypted output');}catch(e){alert('Paste failed: '+e.message);}}
async function pasteEncrypted(){try{const t=await navigator.clipboard.readText(); document.getElementById('decInput').value=t; alert('P// continue from previous script...
async function pasteEncrypted(){
    try {
        const t = await navigator.clipboard.readText();
        document.getElementById('decInput').value = t;
        alert('Pasted into encrypted input');
    } catch (e) {
        alert('Paste failed: ' + e.message);
    }
}

async function copyDecInput(){
    const v = document.getElementById('decInput').value;
    if(!v){alert('No input to copy'); return;}
    try{
        await navigator.clipboard.writeText(v);
        alert('Encrypted input copied');
    } catch(e){
        alert('Copy failed: ' + e.message);
    }
}

// Password strength indicator
function checkPassword(){
    const p = document.getElementById('encPass').value;
    const s = document.getElementById('passwordStrength');
    let score = 0;
    if(p.length>=8) score++;
    if(/[A-Z]/.test(p)) score++;
    if(/[0-9]/.test(p)) score++;
    if(/[\W]/.test(p)) score++;
    const levels=['Very Weak','Weak','Medium','Strong','Very Strong'];
    s.textContent = 'Password Strength: ' + levels[score];
}

// Devtools overlay (basic)
let devtoolsOpen = false;
setInterval(() => {
    const widthThreshold = window.outerWidth - window.innerWidth > 160;
    const heightThreshold = window.outerHeight - window.innerHeight > 160;
    if(widthThreshold || heightThreshold){
        if(!devtoolsOpen){
            document.getElementById('overlay').style.display='flex';
            devtoolsOpen = true;
        }
    } else {
        if(devtoolsOpen){
            document.getElementById('overlay').style.display='none';
            devtoolsOpen = false;
        }
    }
}, 1000);
</script>
</body>
</html>